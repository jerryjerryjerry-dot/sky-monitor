# Sky-Monitor 开发环境 Docker Compose 配置
# 仅包含基础设施服务（Kafka, ClickHouse, PostgreSQL, Redis）
# 前后端服务在宿主机运行，方便开发调试
version: '3.8'

services:
    # Kafka 消息队列
    sky-monitor-kafka:
        image: bitnami/kafka:latest
        container_name: sky-monitor-kafka
        ports:
            - '9092:9092'
            - '9093:9093'
        environment:
            - KAFKA_CFG_PROCESS_ROLES=broker,controller
            - KAFKA_CFG_NODE_ID=1
            - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@sky-monitor-kafka:9093
            - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://sky-monitor-kafka:9092,PLAINTEXT_HOST://localhost:9092
            - KAFKA_CFG_LISTENERS=PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093,PLAINTEXT_HOST://0.0.0.0:29092
            - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
            - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
            - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
            - ALLOW_PLAINTEXT_LISTENER=yes
        volumes:
            - ./data/kafka:/bitnami/kafka
        networks:
            - sky-monitor-network

    # ClickHouse 数据仓库
    sky-monitor-clickhouse:
        image: bitnami/clickhouse:latest
        container_name: sky-monitor-clickhouse
        ports:
            - '8123:8123' # HTTP interface
            - '9000:9000' # Native interface
        environment:
            - CLICKHOUSE_USER=default
            - CLICKHOUSE_PASSWORD=skyclickhouse
            - CLICKHOUSE_DATABASE=default
        volumes:
            - ./data/clickhouse:/bitnami/clickhouse
        networks:
            - sky-monitor-network

    # PostgreSQL 关系数据库
    sky-monitor-postgresql:
        image: bitnami/postgresql:latest
        container_name: sky-monitor-postgresql
        ports:
            - '5432:5432'
        environment:
            - POSTGRESQL_USERNAME=postgres
            - POSTGRESQL_PASSWORD=skypostgres
            - POSTGRESQL_DATABASE=sky_monitor
            - POSTGRESQL_TIMEZONE=Asia/Shanghai
            - POSTGRESQL_LOG_TIMEZONE=Asia/Shanghai
        volumes:
            - ./data/postgresql:/bitnami/postgresql
        networks:
            - sky-monitor-network

    # Redis 缓存
    sky-monitor-redis:
        image: bitnami/redis:latest
        container_name: sky-monitor-redis
        ports:
            - '6379:6379'
        environment:
            - REDIS_PASSWORD=skyredis
        volumes:
            - ./data/redis:/bitnami/redis
        networks:
            - sky-monitor-network

networks:
    sky-monitor-network:
        driver: bridge
